<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø¯ØºØ§Ù… Ú©Ù†Ù†Ø¯Ù‡ Ø¢Ù‡Ù†Ú¯ - Ø³Ø§Ø®Øª Ù„ÛŒØ³Øª Ù¾Ø®Ø´ Ùˆ Ø¯Ø§Ù†Ù„ÙˆØ¯</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>ğŸµ Ø§Ø¯ØºØ§Ù… Ú©Ù†Ù†Ø¯Ù‡ Ø¢Ù‡Ù†Ú¯</h1>
        <p>ÙØ§ÛŒÙ„ Ù‡Ø§ÛŒ ØµÙˆØªÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯ØŒ Ø¨Ù‡ ØµÙˆØ±Øª Ù„ÛŒØ³Øª Ù¾Ø®Ø´ Ú¯ÙˆØ´ Ø¯Ù‡ÛŒØ¯ Ùˆ Ù†Ø³Ø®Ù‡ Ø§Ø¯ØºØ§Ù… Ø´Ø¯Ù‡ Ø±Ø§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯.</p>

        <div class="upload-section">
            <input type="file" id="fileInput" accept="audio/*" multiple>
            <div class="button-group">
                <button onclick="addToPlaylist()">Ø§Ø¶Ø§ÙÙ‡ Ø¨Ù‡ Ù„ÛŒØ³Øª Ù¾Ø®Ø´</button>
                <button onclick="mergeAndDownload()" id="mergeBtn" disabled>Ø§Ø¯ØºØ§Ù… Ùˆ Ø¯Ø§Ù†Ù„ÙˆØ¯</button>
            </div>
            <p id="status"></p>
        </div>

        <div class="playlist-section">
            <h3>Ù„ÛŒØ³Øª Ù¾Ø®Ø´:</h3>
            <ul id="playlist"></ul>
            
            <div class="player-controls">
                <audio id="audioPlayer" controls></audio>
                <div>
                    <button onclick="playNext()">â­ï¸ Ø¨Ø¹Ø¯ÛŒ</button>
                    <button onclick="shufflePlaylist()">ğŸ”€ ØªØµØ§Ø¯ÙÛŒ</button>
                </div>
            </div>
        </div>

        <div class="download-section" id="downloadSection" style="display: none;">
            <h3>âœ… Ø§Ø¯ØºØ§Ù…å®Œæˆ Ø´Ø¯!</h3>
            <button onclick="downloadMergedFile()" class="download-btn">â¬‡ï¸ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø§Ø¯ØºØ§Ù… Ø´Ø¯Ù‡</button>
        </div>
    </div>

    <script>
        // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒå…¨å±€
        let uploadedFiles = [];
        let currentPlayingIndex = -1;
        let mergedAudioBlob = null;

        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¨Ù‡ Ù„ÛŒØ³Øª Ù¾Ø®Ø´
        function addToPlaylist() {
            const fileInput = document.getElementById('fileInput');
            const statusText = document.getElementById('status');
            const mergeBtn = document.getElementById('mergeBtn');

            if (fileInput.files.length === 0) {
                statusText.textContent = "Ù„Ø·ÙØ§ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© ÙØ§ÛŒÙ„ ØµÙˆØªÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.";
                statusText.style.color = "#ff4757";
                return;
            }

            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ù„ÛŒØ³Øª
            for (let i = 0; i < fileInput.files.length; i++) {
                const file = fileInput.files[i];
                if (file.type.startsWith('audio/')) {
                    uploadedFiles.push(file);
                }
            }

            if (uploadedFiles.length > 0) {
                statusText.textContent = `ØªØ¹Ø¯Ø§Ø¯ ${uploadedFiles.length} ÙØ§ÛŒÙ„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯!`;
                statusText.style.color = "#4CAF50";
                mergeBtn.disabled = false;
                updatePlaylist();
            } else {
                statusText.textContent = "Ù‡ÛŒÚ† ÙØ§ÛŒÙ„ ØµÙˆØªÛŒ Ù…Ø¹ØªØ¨Ø±ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.";
                statusText.style.color = "#ff4757";
            }

            fileInput.value = '';
        }

        // Ø¨Ù‡ Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„ÛŒØ³Øª Ù¾Ø®Ø´
        function updatePlaylist() {
            const playlistElement = document.getElementById('playlist');
            playlistElement.innerHTML = '';

            uploadedFiles.forEach((file, index) => {
                const listItem = document.createElement('li');
                
                const fileName = document.createElement('span');
                fileName.textContent = file.name;
                fileName.style.flex = '1';
                
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'Ø­Ø°Ù';
                removeBtn.className = 'remove-btn';
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    removeFromPlaylist(index);
                };

                listItem.appendChild(fileName);
                listItem.appendChild(removeBtn);
                
                listItem.onclick = () => playSong(index);
                playlistElement.appendChild(listItem);
            });
        }

        // Ø­Ø°Ù Ø§Ø² Ù„ÛŒØ³Øª Ù¾Ø®Ø´
        function removeFromPlaylist(index) {
            uploadedFiles.splice(index, 1);
            if (uploadedFiles.length === 0) {
                document.getElementById('mergeBtn').disabled = true;
            }
            updatePlaylist();
            document.getElementById('status').textContent = 'Ø¢ÛŒØªÙ… Ø§Ø² Ù„ÛŒØ³Øª Ø­Ø°Ù Ø´Ø¯.';
        }

        // Ù¾Ø®Ø´ Ø¢Ù‡Ù†Ú¯
        function playSong(index) {
            const audioPlayer = document.getElementById('audioPlayer');
            const file = uploadedFiles[index];

            const objectUrl = URL.createObjectURL(file);
            audioPlayer.src = objectUrl;
            audioPlayer.play();

            currentPlayingIndex = index;

            // Ù‡Ø§ÛŒÙ„Ø§ÛŒØª Ú©Ø±Ø¯Ù† Ø¢Ù‡Ù†Ú¯ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø®Ø´
            const allItems = document.querySelectorAll('#playlist li');
            allItems.forEach(item => item.classList.remove('playing'));
            allItems[index].classList.add('playing');

            // Ù¾Ø®Ø´ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¢Ù‡Ù†Ú¯ Ø¨Ø¹Ø¯ÛŒ
            audioPlayer.onended = function() {
                URL.revokeObjectURL(objectUrl);
                if (uploadedFiles.length > 0) {
                    playNext();
                }
            };
        }

        // Ù¾Ø®Ø´ Ø¢Ù‡Ù†Ú¯ Ø¨Ø¹Ø¯ÛŒ
        function playNext() {
            if (uploadedFiles.length === 0) return;
            
            const nextIndex = (currentPlayingIndex + 1) % uploadedFiles.length;
            playSong(nextIndex);
        }

        // ØªØµØ§Ø¯ÙÛŒ Ú©Ø±Ø¯Ù† Ù„ÛŒØ³Øª Ù¾Ø®Ø´
        function shufflePlaylist() {
            for (let i = uploadedFiles.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [uploadedFiles[i], uploadedFiles[j]] = [uploadedFiles[j], uploadedFiles[i]];
            }
            updatePlaylist();
            document.getElementById('status').textContent = 'Ù„ÛŒØ³Øª Ù¾Ø®Ø´ ØªØµØ§Ø¯ÙÛŒ Ø´Ø¯!';
        }

        // Ø§Ø¯ØºØ§Ù… Ùˆ Ø¯Ø§Ù†Ù„ÙˆØ¯
        async function mergeAndDownload() {
            const statusText = document.getElementById('status');
            const mergeBtn = document.getElementById('mergeBtn');
            
            if (uploadedFiles.length < 2) {
                statusText.textContent = "Ø­Ø¯Ø§Ù‚Ù„ Ø¨Ù‡ 2 ÙØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ø§Ø¯ØºØ§Ù… Ù†ÛŒØ§Ø² Ø¯Ø§Ø±ÛŒØ¯.";
                statusText.style.color = "#ff4757";
                return;
            }

            statusText.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¯ØºØ§Ù… ÙØ§ÛŒÙ„â€ŒÙ‡Ø§... Ù„Ø·ÙØ§ Ù…Ù†ØªØ¸Ø± Ø¨Ù…Ø§Ù†ÛŒØ¯.";
            statusText.style.color = "#007bff";
            mergeBtn.disabled = true;

            try {
                // Ø§ÛŒØ¬Ø§Ø¯ ÛŒÚ© ZIP Ø­Ø§ÙˆÛŒ ØªÙ…Ø§Ù… ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
                const zip = new JSZip();
                
                uploadedFiles.forEach((file, index) => {
                    zip.file(`track-${index + 1}-${file.name}`, file);
                });

                // Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ ZIP
                const zipBlob = await zip.generateAsync({
                    type: "blob",
                    compression: "DEFLATE"
                });

                // Ø°Ø®ÛŒØ±Ù‡ Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯
                mergedAudioBlob = zipBlob;
                
                // Ù†Ù…Ø§ÛŒØ´ Ø¨Ø®Ø´ Ø¯Ø§Ù†Ù„ÙˆØ¯
                document.getElementById('downloadSection').style.display = 'block';
                statusText.textContent = "Ø§Ø¯ØºØ§Ù…å®Œæˆ Ø´Ø¯! Ø­Ø§Ù„Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ÙØ§ÛŒÙ„ Ø±Ø§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯.";
                statusText.style.color = "#4CAF50";
                
            } catch (error) {
                console.error('Error merging files:', error);
                statusText.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¯ØºØ§Ù… ÙØ§ÛŒÙ„â€ŒÙ‡Ø§. Ù„Ø·ÙØ§ Ø¯ÙˆØ¨Ø§Ø±Ù‡å°è¯• Ú©Ù†ÛŒØ¯.";
                statusText.style.color = "#ff4757";
                mergeBtn.disabled = false;
            }
        }

        // Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø§Ø¯ØºØ§Ù… Ø´Ø¯Ù‡
        function downloadMergedFile() {
            if (!mergedAudioBlob) return;
            
            const fileName = `merged-audio-${new Date().toLocaleDateString('fa-IR')}.zip`;
            saveAs(mergedAudioBlob, fileName);
        }
    </script>
</body>
</html>